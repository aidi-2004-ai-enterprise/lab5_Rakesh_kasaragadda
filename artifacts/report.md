# Lab 5 Report — Training & Evaluation Pipeline

_Auto-generated by training_pipeline.py — include these plots/tables in your PDF._

## 1) EDA (why)
- Check missingness/skew to guide preprocessing.
- Focus on target-correlated features for modeling focus.
- Visualize distributions to avoid removing true risk outliers.
- Keep EDA lean for reproducibility.

**Artifacts:**
- missing_values_top30: `artifacts\eda\missing_values_top30.png`
- target_distribution: `artifacts\eda\target_distribution.png`
- corr_heatmap_top: `artifacts\eda\corr_heatmap_top.png`
- hists_top12: `artifacts\eda\hists_top12.png`

## 2) Preprocessing & Imbalance & PSI (why)
- Median imputation; scale only Logistic Regression; trees are scale-invariant.
- Stratified split preserves ~3.2% minority; class weights avoid synthetic artifacts.
- PSI(train vs test) < 0.10 across top features → no sampling bias; fair evaluation.
- Same preprocessing pipeline for all models for fair comparison.

**PSI Top 15 (head):**

| feature                               |        psi |
|:--------------------------------------|-----------:|
| Cash flow rate                        | 0.0161146  |
| Fixed Assets to Assets                | 0.0157882  |
| Inventory/Working Capital             | 0.0149772  |
| Operating profit per person           | 0.013332   |
| Long-term fund suitability ratio (A)  | 0.0127531  |
| Net Value Per Share (C)               | 0.0106463  |
| Total Asset Turnover                  | 0.0103558  |
| Net Value Per Share (A)               | 0.0103321  |
| Cash Reinvestment %                   | 0.010292   |
| Working Capital to Total Assets       | 0.0099085  |
| Working Capital/Equity                | 0.00945686 |
| Net Value Per Share (B)               | 0.00933865 |
| Total expense/Assets                  | 0.00902056 |
| Net profit before tax/Paid-in capital | 0.00866843 |
| Current Ratio                         | 0.00825214 |

- psi_top15: `artifacts\psi\psi_top15.png`
- psi_overlay_top1: `artifacts\psi\psi_overlay_ Cash flow rate.png`

## 3) Feature Selection (simple) (why)
- Correlation filter (|r|>0.95) drops redundancies; reduces variance.
- Preserve interpretability (skip PCA unless overfitting appears).
- Apply once; share across models for fairness.
- Retain most informative features wrt target.

**Selected features (after correlation filter) — count=75**

```
 ROA(C) before interest and depreciation before interest,  ROA(A) before interest and % after tax,  Operating Gross Margin,  Operating Profit Rate,  Non-industry income and expenditure/revenue,  Operating Expense Rate,  Research and development expense rate,  Cash flow rate,  Interest-bearing debt interest rate,  Tax rate (A),  Net Value Per Share (B),  Persistent EPS in the Last Four Seasons,  Cash Flow Per Share,  Revenue Per Share (Yuan ¥),  Operating Profit Per Share (Yuan ¥),  Realized Sales Gross Profit Growth Rate,  Operating Profit Growth Rate,  After-tax Net Profit Growth Rate,  Continuous Net Profit Growth Rate,  Total Asset Growth Rate,  Net Value Growth Rate,  Cash Reinvestment %,  Current Ratio,  Quick Ratio,  Interest Expense Ratio,  Total debt/Total net worth,  Debt ratio %,  Long-term fund suitability ratio (A),  Borrowing dependency,  Contingent liabilities/Net worth,  Inventory and accounts receivable/Net value,  Total Asset Turnover,  Accounts Receivable Turnover,  Average Collection Days,  Inventory Turnover Rate (times),  Fixed Assets Turnover Frequency,  Net Worth Turnover Rate (times),  Revenue per person,  Operating profit per person,  Allocation rate per person,  Working Capital to Total Assets,  Quick Assets/Total Assets,  Current Assets/Total Assets,  Cash/Total Assets,  Quick Assets/Current Liability,  Cash/Current Liability,  Current Liability to Assets,  Operating Funds to Liability,  Inventory/Working Capital,  Inventory/Current Liability,  Current Liabilities/Liability,  Working Capital/Equity,  Current Liabilities/Equity,  Long-term Liability to Current Assets,  Retained Earnings to Total Assets,  Total income/Total expense,  Total expense/Assets,  Current Asset Turnover Rate,  Quick Asset Turnover Rate,  Cash Turnover Rate,  Fixed Assets to Assets,  Equity to Long-term Liability,  Cash Flow to Total Assets,  Cash Flow to Liability,  CFO to Assets,  Cash Flow to Equity,  Current Liability to Current Assets,  Liability-Assets Flag,  Total assets to GNP price,  No-credit Interval,  Net Income to Stockholder's Equity,  Degree of Financial Leverage (DFL),  Interest Coverage Ratio (Interest expense to EBIT),  Net Income Flag,  Equity to Liability
```

## 4) Hyperparameter Tuning (simple) (why)
- RandomizedSearchCV with StratifiedKFold(5) using PR-AUC (handles imbalance).
- Small, efficient search spaces to balance compute and performance.
- Parameterized per model; seeds fixed for reproducibility.
- Best params & CV PR-AUC below.

```
{'logreg': {'best_params': {'clf__penalty': 'l2',
                            'clf__C': np.float64(3.359818286283781)},
            'best_score_ap_cv': 0.3823375732363562},
 'rf': {'best_params': {'clf__n_estimators': np.int64(300),
                        'clf__min_samples_leaf': 4,
                        'clf__max_features': 'log2',
                        'clf__max_depth': None},
        'best_score_ap_cv': 0.4275780353859432},
 'xgb': {'best_params': {'clf__subsample': np.float64(1.0),
                         'clf__reg_lambda': np.float64(1.5),
                         'clf__n_estimators': np.int64(550),
                         'clf__max_depth': 7,
                         'clf__learning_rate': np.float64(0.07857142857142857),
                         'clf__colsample_bytree': np.float64(1.0)},
         'best_score_ap_cv': 0.4371034719963164}}
```

## 5–6) Training, Calibration, ROC & Comparison (why)
- Train LR benchmark + two non-linear models with identical splits.
- Assess discrimination (ROC-AUC) & probability quality (Calibration, Brier).
- Compare train vs test to spot over/underfitting; prefer stable, calibrated model.
- Primary selection metric: PR-AUC (minority prevalence ~3.2%).

**Comparison table (train/test):**

| model   |   train_pr_auc |   test_pr_auc |   train_roc_auc |   test_roc_auc |   train_brier |   test_brier |   train_f1@0.5 |   test_f1@0.5 |
|:--------|---------------:|--------------:|----------------:|---------------:|--------------:|-------------:|---------------:|--------------:|
| logreg  |         0.4648 |        0.2791 |          0.9606 |         0.873  |        0.0833 |       0.0903 |         0.3333 |        0.2636 |
| rf      |         0.9956 |        0.4718 |          0.9999 |         0.9556 |        0.0082 |       0.0235 |         0.9419 |        0.4561 |
| xgb     |         1      |        0.481  |          1      |         0.9518 |        0      |       0.026  |         1      |        0.4248 |

**Saved evaluation plots:** (each has train+test overlay)
- Calibration: `artifacts/evaluation/calibration_logreg.png`
- ROC: `artifacts/evaluation/roc_logreg.png`
- Calibration: `artifacts/evaluation/calibration_rf.png`
- ROC: `artifacts/evaluation/roc_rf.png`
- Calibration: `artifacts/evaluation/calibration_xgb.png`
- ROC: `artifacts/evaluation/roc_xgb.png`

## 7) SHAP Interpretability (why)
- Reveal global drivers & local attributions to support governance.
- Align drivers with business intuition (cash flow, leverage, liquidity).
- TreeExplainer for tree models; summary beeswarm & bar.

- shap_beeswarm: `artifacts\shap\shap_summary_beeswarm.png`
- shap_bar: `artifacts\shap\shap_summary_bar.png`

## 8) PSI — Drift Monitoring (why)
- PSI < 0.10: stable; 0.10–0.20: monitor; >0.20: investigate / retrain.
- Today’s train vs test PSI indicates stable evaluation; set periodic PSI checks in production.
- If drift detected, re-sample / re-tune / re-train before deployment.

## 9) Challenges & Reflections
- Compute budget → small/efficient random search.
- Class imbalance → PR-AUC objective + class weights; avoided synthetic data.
- Interpretability vs performance → skipped PCA; added SHAP for transparency.
- Reproducibility → fixed seeds; deterministic plots & CSVs.

## Recommendation
- Best model by test PR-AUC: **xgb**.
- Next: threshold tuning to business KPI, add SHAP report to MRM, set PSI monitors in Airflow.
